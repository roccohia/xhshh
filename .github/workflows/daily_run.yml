name: å°çº¢ä¹¦æ•°æ®åˆ†æžè‡ªåŠ¨åŒ–ä»»åŠ¡

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 9:00 è¿è¡Œ (UTC 1:00)
    - cron: '0 1 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  TZ: Asia/Shanghai

jobs:
  xhs-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        mkdir -p core/media_crawler/data/xhs
        mkdir -p output
        mkdir -p logs
        mkdir -p config
        echo "æ£€æŸ¥ MediaCrawler æ–‡ä»¶:"
        ls -la core/media_crawler/main.py || echo "main.py ä¸å­˜åœ¨"
        echo "æ£€æŸ¥ MediaCrawler ç›®å½•ç»“æž„:"
        ls -la core/media_crawler/ | head -5
        
    - name: è®¾ç½®æ—¶åŒº
      run: |
        sudo timedatectl set-timezone Asia/Shanghai
        
    - name: è¿è¡Œæ•°æ®çˆ¬å–
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "å¼€å§‹çˆ¬å–å°çº¢ä¹¦æ•°æ®..."
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "æ£€æŸ¥å…³é”®è¯é…ç½®:"
        if [ -f "config/keywords.txt" ]; then
          echo "ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å…³é”®è¯:"
          cat config/keywords.txt
        else
          echo "ä½¿ç”¨é»˜è®¤å…³é”®è¯: æ™®æ‹‰æ,å¥èº«,ç‘œä¼½"
        fi

        echo "ðŸš€ å°è¯•çœŸå®žæ•°æ®çˆ¬å–..."
        python scripts/xhs_crawler_direct.py

        echo "ðŸ“ æ£€æŸ¥çˆ¬å–ç»“æžœ:"
        if [ -d "core/media_crawler/data/xhs" ] && [ "$(ls -A core/media_crawler/data/xhs/*.csv 2>/dev/null)" ]; then
          echo "âœ… å‘çŽ°çœŸå®žæ•°æ®æ–‡ä»¶"
          ls -la core/media_crawler/data/xhs/*.csv
        else
          echo "âŒ æœªå‘çŽ°çœŸå®žæ•°æ®æ–‡ä»¶"
          echo "ðŸš« ä¸ä¼šç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼Œåªä½¿ç”¨çœŸå®žæ•°æ®è¿›è¡Œåˆ†æž"
          echo "ðŸ’¡ è¯·æ£€æŸ¥ Cookie é…ç½®æˆ–ç½‘ç»œè¿žæŽ¥"
        fi
      continue-on-error: true
      
    - name: æ£€æŸ¥çˆ¬å–ç»“æžœ
      id: check_data
      run: |
        if [ -d "core/media_crawler/data/xhs" ] && [ "$(ls -A core/media_crawler/data/xhs/*.csv 2>/dev/null)" ]; then
          echo "data_exists=true" >> $GITHUB_OUTPUT
          latest_file=$(ls -t core/media_crawler/data/xhs/*_search_contents_*.csv | head -1)
          echo "latest_file=$latest_file" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ°æ•°æ®æ–‡ä»¶: $latest_file"
        else
          echo "data_exists=false" >> $GITHUB_OUTPUT
          echo "æœªæ‰¾åˆ°çœŸå®žçˆ¬å–æ•°æ®ï¼Œè·³è¿‡åˆ†æžæ­¥éª¤"
        fi
        
    - name: è¿è¡Œæ•°æ®åˆ†æž
      if: steps.check_data.outputs.data_exists == 'true'
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "å¼€å§‹æ•°æ®åˆ†æž..."
        python analysis/run_analysis_simple.py --input latest
      continue-on-error: true
      
    - name: ç”Ÿæˆ Notion å†…å®¹æ—¥åŽ†
      if: steps.check_data.outputs.data_exists == 'true'
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ç”Ÿæˆ Notion å†…å®¹æ—¥åŽ†..."
        python analysis/export_notionsheet.py --days 30
      continue-on-error: true
      
    - name: æŽ¨é€åˆ° Telegram
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "æŽ¨é€ç»“æžœåˆ° Telegram..."
        python scripts/telegram_push.py --token "$BOT_TOKEN" --chat-id "$CHAT_ID"
      continue-on-error: true
      
    - name: ä¸Šä¼ åˆ†æžç»“æžœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: analysis-results-${{ github.run_number }}
        path: |
          output/
          logs/
        retention-days: 7
        
    - name: æ¸…ç†æ—§æ–‡ä»¶
      run: |
        # ä¿ç•™æœ€è¿‘3å¤©çš„æ•°æ®æ–‡ä»¶
        find core/media_crawler/data/xhs -name "*.csv" -mtime +3 -delete 2>/dev/null || true
        find output -name "*.csv" -mtime +7 -delete 2>/dev/null || true
        find output -name "*.png" -mtime +7 -delete 2>/dev/null || true
